version: '3'

tasks:
  upgrade:
    desc: Upgrade a Helm release
    env:
      HELM_VALUES_PATH:
        sh: echo "${HELM_VALUES_PATH:-values.yaml}"
      COMMIT_SHA:
        sh: echo "${COMMIT_SHA:-unknown}"
    cmds:
      - if [ -z "${HELM_NAMESPACE}" ]; then echo "NAMESPACE var is not set"; exit 1; fi
      - if [ -z "${HELM_RELEASE}" ]; then echo "NAMESPACE var is not set"; exit 1; fi
      - if [ -z "${HELM_CHART}" ]; then echo "CHART var is not set"; exit 1; fi
      - if [ -z "${HELM_VALUES_PATH}" ]; then echo "VALUES_PATH var is not set"; exit 1; fi
      - if [ ! -z "${HELM_REPOSITORY}" ]; then helm repo add ${HELM_REPOSITORY} && helm repo update; fi
      - helm upgrade -i -n ${HELM_NAMESPACE} --create-namespace -f ${HELM_VALUES_PATH} --set "app.kubernetes.io/commit=${COMMIT_SHA}" ${HELM_RELEASE} ${HELM_CHART}
